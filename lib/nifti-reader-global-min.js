"use strict";var nifti=(()=>{var J=Object.defineProperty;var Mt=Object.getOwnPropertyDescriptor;var Ct=Object.getOwnPropertyNames;var Ft=Object.prototype.hasOwnProperty;var Ut=(i,t)=>{for(var e in t)J(i,e,{get:t[e],enumerable:!0})},Nt=(i,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Ct(t))!Ft.call(i,n)&&n!==e&&J(i,n,{get:()=>t[n],enumerable:!(r=Mt(t,n))||r.enumerable});return i};var zt=i=>Nt(J({},"__esModule",{value:!0}),i);var re={};Ut(re,{NIFTI1:()=>d,NIFTI2:()=>A,NIFTIEXTENSION:()=>V,Utils:()=>l,decompress:()=>At,decompressAsync:()=>$t,decompressHeaderAsync:()=>rt,hasExtension:()=>te,isCompressed:()=>ot,isNIFTI:()=>Wt,isNIFTI1:()=>st,isNIFTI2:()=>at,readExtension:()=>ie,readExtensionData:()=>ne,readHeader:()=>It,readHeaderAsync:()=>Jt,readImage:()=>ee});var N=Uint8Array,H=Uint16Array,Dt=Int32Array,gt=new N([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),pt=new N([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),bt=new N([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),mt=function(i,t){for(var e=new H(31),r=0;r<31;++r)e[r]=t+=1<<i[r-1];for(var n=new Dt(e[30]),r=1;r<30;++r)for(var o=e[r];o<e[r+1];++o)n[o]=o-e[r]<<5|r;return{b:e,r:n}},dt=mt(gt,2),xt=dt.b,qt=dt.r;xt[28]=258,qt[258]=28;var Et=mt(pt,0),Bt=Et.b,ae=Et.r,it=new H(32768);for(x=0;x<32768;++x)O=(x&43690)>>1|(x&21845)<<1,O=(O&52428)>>2|(O&13107)<<2,O=(O&61680)>>4|(O&3855)<<4,it[x]=((O&65280)>>8|(O&255)<<8)>>1;var O,x,K=function(i,t,e){for(var r=i.length,n=0,o=new H(t);n<r;++n)i[n]&&++o[i[n]-1];var s=new H(t);for(n=1;n<t;++n)s[n]=s[n-1]+o[n-1]<<1;var h;if(e){h=new H(1<<t);var f=15-t;for(n=0;n<r;++n)if(i[n])for(var u=n<<4|i[n],g=t-i[n],a=s[i[n]-1]++<<g,c=a|(1<<g)-1;a<=c;++a)h[it[a]>>f]=u}else for(h=new H(r),n=0;n<r;++n)i[n]&&(h[n]=it[s[i[n]-1]++]>>15-i[n]);return h},Q=new N(288);for(x=0;x<144;++x)Q[x]=8;var x;for(x=144;x<256;++x)Q[x]=9;var x;for(x=256;x<280;++x)Q[x]=7;var x;for(x=280;x<288;++x)Q[x]=8;var x,yt=new N(32);for(x=0;x<32;++x)yt[x]=5;var x;var Ot=K(Q,9,1);var Pt=K(yt,5,1),tt=function(i){for(var t=i[0],e=1;e<i.length;++e)i[e]>t&&(t=i[e]);return t},b=function(i,t,e){var r=t/8|0;return(i[r]|i[r+1]<<8)>>(t&7)&e},et=function(i,t){var e=t/8|0;return(i[e]|i[e+1]<<8|i[e+2]<<16)>>(t&7)},Rt=function(i){return(i+7)/8|0},Lt=function(i,t,e){return(t==null||t<0)&&(t=0),(e==null||e>i.length)&&(e=i.length),new N(i.subarray(t,e))};var Gt=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],U=function(i,t,e){var r=new Error(t||Gt[i]);if(r.code=i,Error.captureStackTrace&&Error.captureStackTrace(r,U),!e)throw r;return r},nt=function(i,t,e,r){var n=i.length,o=r?r.length:0;if(!n||t.f&&!t.l)return e||new N(0);var s=!e,h=s||t.i!=2,f=t.i;s&&(e=new N(n*3));var u=function(ut){var ct=e.length;if(ut>ct){var vt=new N(Math.max(ct*2,ut));vt.set(e),e=vt}},g=t.f||0,a=t.p||0,c=t.b||0,v=t.l,p=t.d,m=t.m,E=t.n,C=n*8;do{if(!v){g=b(i,a,1);var I=b(i,a+1,3);if(a+=3,I)if(I==1)v=Ot,p=Pt,m=9,E=5;else if(I==2){var G=b(i,a,31)+257,Z=b(i,a+10,15)+4,k=G+b(i,a+5,31)+1;a+=14;for(var B=new N(k),P=new N(19),S=0;S<Z;++S)P[bt[S]]=b(i,a+S*3,7);a+=Z*3;for(var T=tt(P),y=(1<<T)-1,q=K(P,T,1),S=0;S<k;){var z=q[b(i,a,y)];a+=z&15;var w=z>>4;if(w<16)B[S++]=w;else{var M=0,F=0;for(w==16?(F=3+b(i,a,3),a+=2,M=B[S-1]):w==17?(F=3+b(i,a,7),a+=3):w==18&&(F=11+b(i,a,127),a+=7);F--;)B[S++]=M}}var D=B.subarray(0,G),_=B.subarray(G);m=tt(D),E=tt(_),v=K(D,m,1),p=K(_,E,1)}else U(1);else{var w=Rt(a)+4,R=i[w-4]|i[w-3]<<8,L=w+R;if(L>n){f&&U(0);break}h&&u(c+R),e.set(i.subarray(w,L),c),t.b=c+=R,t.p=a=L*8,t.f=g;continue}if(a>C){f&&U(0);break}}h&&u(c+131072);for(var wt=(1<<m)-1,St=(1<<E)-1,j=a;;j=a){var M=v[et(i,a)&wt],Y=M>>4;if(a+=M&15,a>C){f&&U(0);break}if(M||U(2),Y<256)e[c++]=Y;else if(Y==256){j=a,v=null;break}else{var ft=Y-254;if(Y>264){var S=Y-257,X=gt[S];ft=b(i,a,(1<<X)-1)+xt[S],a+=X}var W=p[et(i,a)&St],$=W>>4;W||U(3),a+=W&15;var _=Bt[$];if($>3){var X=pt[$];_+=et(i,a)&(1<<X)-1,a+=X}if(a>C){f&&U(0);break}h&&u(c+131072);var lt=c+ft;if(c<_){var ht=o-_,Tt=Math.min(_,lt);for(ht+c<0&&U(3);c<Tt;++c)e[c]=r[ht+c]}for(;c<lt;++c)e[c]=e[c-_]}}t.l=v,t.p=j,t.b=c,t.f=g,v&&(g=1,t.m=m,t.d=p,t.n=E)}while(!g);return c!=e.length&&s?Lt(e,0,c):e.subarray(0,c)};var Zt=new N(0);var kt=function(i){(i[0]!=31||i[1]!=139||i[2]!=8)&&U(6,"invalid gzip data");var t=i[3],e=10;t&4&&(e+=(i[10]|i[11]<<8)+2);for(var r=(t>>3&1)+(t>>4&1);r>0;r-=!i[e++]);return e+(t&2)},Yt=function(i){var t=i.length;return(i[t-4]|i[t-3]<<8|i[t-2]<<16|i[t-1]<<24)>>>0};var Ht=function(i,t){return((i[0]&15)!=8||i[0]>>4>7||(i[0]<<8|i[1])%31)&&U(6,"invalid zlib data"),(i[1]>>5&1)==+!t&&U(6,"invalid zlib data: "+(i[1]&32?"need":"unexpected")+" dictionary"),(i[1]>>3&4)+2};function Vt(i,t){return nt(i,{i:2},t&&t.out,t&&t.dictionary)}function Xt(i,t){var e=kt(i);return e+8>i.length&&U(6,"invalid gzip data"),nt(i.subarray(e,-8),{i:2},t&&t.out||new N(Yt(i)),t&&t.dictionary)}function Kt(i,t){return nt(i.subarray(Ht(i,t&&t.dictionary),-4),{i:2},t&&t.out,t&&t.dictionary)}function _t(i,t){return i[0]==31&&i[1]==139&&i[2]==8?Xt(i,t):(i[0]&15)!=8||i[0]>>4>7||(i[0]<<8|i[1])%31?Vt(i,t):Kt(i,t)}var Qt=typeof TextDecoder<"u"&&new TextDecoder,jt=0;try{Qt.decode(Zt,{stream:!0}),jt=1}catch{}var V=class{esize;ecode;edata;littleEndian;constructor(t,e,r,n){if(t%16!=0)throw new Error("This does not appear to be a NIFTI extension");this.esize=t,this.ecode=e,this.edata=r,this.littleEndian=n}toArrayBuffer(){let t=new Uint8Array(this.esize),e=new Uint8Array(this.edata);t.set(e,8);let r=new DataView(t.buffer);return r.setInt32(0,this.esize,this.littleEndian),r.setInt32(4,this.ecode,this.littleEndian),t.buffer}};var l=class i{static crcTable=null;static GUNZIP_MAGIC_COOKIE1=31;static GUNZIP_MAGIC_COOKIE2=139;static getStringAt(t,e,r){var n="",o,s;for(o=e;o<r;o+=1)s=t.getUint8(o),s!==0&&(n+=String.fromCharCode(s));return n}static getByteAt=function(t,e){return t.getUint8(e)};static getShortAt=function(t,e,r){return t.getInt16(e,r)};static getIntAt(t,e,r){return t.getInt32(e,r)}static getFloatAt(t,e,r){return t.getFloat32(e,r)}static getDoubleAt(t,e,r){return t.getFloat64(e,r)}static getInt64At(t,e,r){let n=t.getUint32(e,r),o=t.getInt32(e+4,r),s;return r?s=o*2**32+n:s=n*2**32+o,o<0&&(s+=-1*2**32*2**32),s}static getUint64At(t,e,r){let n=t.getUint32(e+(r?0:4),r),o=t.getUint32(e+(r?4:0),r);return r?o*2**32+n:n*2**32+o}static getExtensionsAt(t,e,r,n){let o=[],s=e;for(;s<n;){let h=r,f=i.getIntAt(t,s,r);if(!f)break;if(f+s>n&&(h=!h,f=i.getIntAt(t,s,h),f+s>n))throw new Error("This does not appear to be a valid NIFTI extension");if(f%16!=0)throw new Error("This does not appear to be a NIFTI extension");let u=i.getIntAt(t,s+4,h),g=t.buffer.slice(s+8,s+f),a=new V(f,u,g,h);o.push(a),s+=f}return o}static toArrayBuffer(t){var e,r,n;for(e=new ArrayBuffer(t.length),r=new Uint8Array(e),n=0;n<t.length;n+=1)r[n]=t[n];return e}static isString(t){return typeof t=="string"||t instanceof String}static formatNumber(t,e=void 0){let r;return i.isString(t)?r=Number(t):r=t,e?r=r.toPrecision(5):r=r.toPrecision(7),parseFloat(r)}static makeCRCTable(){let t,e=[];for(var r=0;r<256;r++){t=r;for(var n=0;n<8;n++)t=t&1?3988292384^t>>>1:t>>>1;e[r]=t}return e}static crc32(t){i.crcTable||(i.crcTable=i.makeCRCTable());let e=i.crcTable,r=-1;for(var n=0;n<t.byteLength;n++)r=r>>>8^e[(r^t.getUint8(n))&255];return(r^-1)>>>0}};var d=class i{littleEndian=!1;dim_info=0;dims=[];intent_p1=0;intent_p2=0;intent_p3=0;intent_code=0;datatypeCode=0;numBitsPerVoxel=0;slice_start=0;slice_end=0;slice_code=0;pixDims=[];vox_offset=0;scl_slope=1;scl_inter=0;xyzt_units=0;cal_max=0;cal_min=0;slice_duration=0;toffset=0;description="";aux_file="";intent_name="";qform_code=0;sform_code=0;quatern_a=0;quatern_b=0;quatern_c=0;quatern_d=0;qoffset_x=0;qoffset_y=0;qoffset_z=0;affine=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];qfac=1;quatern_R;magic="0";isHDR=!1;extensionFlag=[0,0,0,0];extensionSize=0;extensionCode=0;extensions=[];static TYPE_NONE=0;static TYPE_BINARY=1;static TYPE_UINT8=2;static TYPE_INT16=4;static TYPE_INT32=8;static TYPE_FLOAT32=16;static TYPE_COMPLEX64=32;static TYPE_FLOAT64=64;static TYPE_RGB24=128;static TYPE_INT8=256;static TYPE_UINT16=512;static TYPE_UINT32=768;static TYPE_INT64=1024;static TYPE_UINT64=1280;static TYPE_FLOAT128=1536;static TYPE_COMPLEX128=1792;static TYPE_COMPLEX256=2048;static XFORM_UNKNOWN=0;static XFORM_SCANNER_ANAT=1;static XFORM_ALIGNED_ANAT=2;static XFORM_TALAIRACH=3;static XFORM_MNI_152=4;static SPATIAL_UNITS_MASK=7;static TEMPORAL_UNITS_MASK=56;static UNITS_UNKNOWN=0;static UNITS_METER=1;static UNITS_MM=2;static UNITS_MICRON=3;static UNITS_SEC=8;static UNITS_MSEC=16;static UNITS_USEC=24;static UNITS_HZ=32;static UNITS_PPM=40;static UNITS_RADS=48;static MAGIC_COOKIE=348;static STANDARD_HEADER_SIZE=348;static MAGIC_NUMBER_LOCATION=344;static MAGIC_NUMBER=[110,43,49];static MAGIC_NUMBER2=[110,105,49];static EXTENSION_HEADER_SIZE=8;readHeader(t){var e=new DataView(t),r=l.getIntAt(e,0,this.littleEndian),n,o,s,h;if(r!==i.MAGIC_COOKIE&&(this.littleEndian=!0,r=l.getIntAt(e,0,this.littleEndian)),r!==i.MAGIC_COOKIE)throw new Error("This does not appear to be a NIFTI file!");for(this.dim_info=l.getByteAt(e,39),n=0;n<8;n+=1)h=40+n*2,this.dims[n]=l.getShortAt(e,h,this.littleEndian);for(this.intent_p1=l.getFloatAt(e,56,this.littleEndian),this.intent_p2=l.getFloatAt(e,60,this.littleEndian),this.intent_p3=l.getFloatAt(e,64,this.littleEndian),this.intent_code=l.getShortAt(e,68,this.littleEndian),this.datatypeCode=l.getShortAt(e,70,this.littleEndian),this.numBitsPerVoxel=l.getShortAt(e,72,this.littleEndian),this.slice_start=l.getShortAt(e,74,this.littleEndian),n=0;n<8;n+=1)h=76+n*4,this.pixDims[n]=l.getFloatAt(e,h,this.littleEndian);if(this.vox_offset=l.getFloatAt(e,108,this.littleEndian),this.scl_slope=l.getFloatAt(e,112,this.littleEndian),this.scl_inter=l.getFloatAt(e,116,this.littleEndian),this.slice_end=l.getShortAt(e,120,this.littleEndian),this.slice_code=l.getByteAt(e,122),this.xyzt_units=l.getByteAt(e,123),this.cal_max=l.getFloatAt(e,124,this.littleEndian),this.cal_min=l.getFloatAt(e,128,this.littleEndian),this.slice_duration=l.getFloatAt(e,132,this.littleEndian),this.toffset=l.getFloatAt(e,136,this.littleEndian),this.description=l.getStringAt(e,148,228),this.aux_file=l.getStringAt(e,228,252),this.qform_code=l.getShortAt(e,252,this.littleEndian),this.sform_code=l.getShortAt(e,254,this.littleEndian),this.quatern_b=l.getFloatAt(e,256,this.littleEndian),this.quatern_c=l.getFloatAt(e,260,this.littleEndian),this.quatern_d=l.getFloatAt(e,264,this.littleEndian),this.quatern_a=Math.sqrt(1-(Math.pow(this.quatern_b,2)+Math.pow(this.quatern_c,2)+Math.pow(this.quatern_d,2))),this.qoffset_x=l.getFloatAt(e,268,this.littleEndian),this.qoffset_y=l.getFloatAt(e,272,this.littleEndian),this.qoffset_z=l.getFloatAt(e,276,this.littleEndian),this.qform_code<1&&this.sform_code<1&&(this.affine[0][0]=this.pixDims[1],this.affine[1][1]=this.pixDims[2],this.affine[2][2]=this.pixDims[3]),this.qform_code>0&&this.sform_code<this.qform_code){let f=this.quatern_a,u=this.quatern_b,g=this.quatern_c,a=this.quatern_d;for(this.qfac=this.pixDims[0]===0?1:this.pixDims[0],this.quatern_R=[[f*f+u*u-g*g-a*a,2*u*g-2*f*a,2*u*a+2*f*g],[2*u*g+2*f*a,f*f+g*g-u*u-a*a,2*g*a-2*f*u],[2*u*a-2*f*g,2*g*a+2*f*u,f*f+a*a-g*g-u*u]],o=0;o<3;o+=1)for(s=0;s<3;s+=1)this.affine[o][s]=this.quatern_R[o][s]*this.pixDims[s+1],s===2&&(this.affine[o][s]*=this.qfac);this.affine[0][3]=this.qoffset_x,this.affine[1][3]=this.qoffset_y,this.affine[2][3]=this.qoffset_z}else if(this.sform_code>0)for(o=0;o<3;o+=1)for(s=0;s<4;s+=1)h=280+(o*4+s)*4,this.affine[o][s]=l.getFloatAt(e,h,this.littleEndian);if(this.affine[3][0]=0,this.affine[3][1]=0,this.affine[3][2]=0,this.affine[3][3]=1,this.intent_name=l.getStringAt(e,328,344),this.magic=l.getStringAt(e,344,348),this.isHDR=this.magic===String.fromCharCode.apply(null,i.MAGIC_NUMBER2),e.byteLength>i.MAGIC_COOKIE){this.extensionFlag[0]=l.getByteAt(e,348),this.extensionFlag[1]=l.getByteAt(e,349),this.extensionFlag[2]=l.getByteAt(e,350),this.extensionFlag[3]=l.getByteAt(e,351);let f=!0;!this.isHDR&&this.vox_offset<=352&&(f=!1),e.byteLength<=368&&(f=!1),f&&this.extensionFlag[0]&&(this.extensions=l.getExtensionsAt(e,this.getExtensionLocation(),this.littleEndian,this.vox_offset),this.extensionSize=this.extensions[0].esize,this.extensionCode=this.extensions[0].ecode)}}toFormattedString(){var t=l.formatNumber,e="";return e+="Dim Info = "+this.dim_info+`
`,e+="Image Dimensions (1-8): "+this.dims[0]+", "+this.dims[1]+", "+this.dims[2]+", "+this.dims[3]+", "+this.dims[4]+", "+this.dims[5]+", "+this.dims[6]+", "+this.dims[7]+`
`,e+="Intent Parameters (1-3): "+this.intent_p1+", "+this.intent_p2+", "+this.intent_p3+`
`,e+="Intent Code = "+this.intent_code+`
`,e+="Datatype = "+this.datatypeCode+" ("+this.getDatatypeCodeString(this.datatypeCode)+`)
`,e+="Bits Per Voxel = "+this.numBitsPerVoxel+`
`,e+="Slice Start = "+this.slice_start+`
`,e+="Voxel Dimensions (1-8): "+t(this.pixDims[0])+", "+t(this.pixDims[1])+", "+t(this.pixDims[2])+", "+t(this.pixDims[3])+", "+t(this.pixDims[4])+", "+t(this.pixDims[5])+", "+t(this.pixDims[6])+", "+t(this.pixDims[7])+`
`,e+="Image Offset = "+this.vox_offset+`
`,e+="Data Scale:  Slope = "+t(this.scl_slope)+"  Intercept = "+t(this.scl_inter)+`
`,e+="Slice End = "+this.slice_end+`
`,e+="Slice Code = "+this.slice_code+`
`,e+="Units Code = "+this.xyzt_units+" ("+this.getUnitsCodeString(i.SPATIAL_UNITS_MASK&this.xyzt_units)+", "+this.getUnitsCodeString(i.TEMPORAL_UNITS_MASK&this.xyzt_units)+`)
`,e+="Display Range:  Max = "+t(this.cal_max)+"  Min = "+t(this.cal_min)+`
`,e+="Slice Duration = "+this.slice_duration+`
`,e+="Time Axis Shift = "+this.toffset+`
`,e+='Description: "'+this.description+`"
`,e+='Auxiliary File: "'+this.aux_file+`"
`,e+="Q-Form Code = "+this.qform_code+" ("+this.getTransformCodeString(this.qform_code)+`)
`,e+="S-Form Code = "+this.sform_code+" ("+this.getTransformCodeString(this.sform_code)+`)
`,e+="Quaternion Parameters:  b = "+t(this.quatern_b)+"  c = "+t(this.quatern_c)+"  d = "+t(this.quatern_d)+`
`,e+="Quaternion Offsets:  x = "+this.qoffset_x+"  y = "+this.qoffset_y+"  z = "+this.qoffset_z+`
`,e+="S-Form Parameters X: "+t(this.affine[0][0])+", "+t(this.affine[0][1])+", "+t(this.affine[0][2])+", "+t(this.affine[0][3])+`
`,e+="S-Form Parameters Y: "+t(this.affine[1][0])+", "+t(this.affine[1][1])+", "+t(this.affine[1][2])+", "+t(this.affine[1][3])+`
`,e+="S-Form Parameters Z: "+t(this.affine[2][0])+", "+t(this.affine[2][1])+", "+t(this.affine[2][2])+", "+t(this.affine[2][3])+`
`,e+='Intent Name: "'+this.intent_name+`"
`,this.extensionFlag[0]&&(e+="Extension: Size = "+this.extensionSize+"  Code = "+this.extensionCode+`
`),e}getDatatypeCodeString=function(t){return t===i.TYPE_UINT8?"1-Byte Unsigned Integer":t===i.TYPE_INT16?"2-Byte Signed Integer":t===i.TYPE_INT32?"4-Byte Signed Integer":t===i.TYPE_FLOAT32?"4-Byte Float":t===i.TYPE_FLOAT64?"8-Byte Float":t===i.TYPE_RGB24?"RGB":t===i.TYPE_INT8?"1-Byte Signed Integer":t===i.TYPE_UINT16?"2-Byte Unsigned Integer":t===i.TYPE_UINT32?"4-Byte Unsigned Integer":t===i.TYPE_INT64?"8-Byte Signed Integer":t===i.TYPE_UINT64?"8-Byte Unsigned Integer":"Unknown"};getTransformCodeString=function(t){return t===i.XFORM_SCANNER_ANAT?"Scanner":t===i.XFORM_ALIGNED_ANAT?"Aligned":t===i.XFORM_TALAIRACH?"Talairach":t===i.XFORM_MNI_152?"MNI":"Unknown"};getUnitsCodeString=function(t){return t===i.UNITS_METER?"Meters":t===i.UNITS_MM?"Millimeters":t===i.UNITS_MICRON?"Microns":t===i.UNITS_SEC?"Seconds":t===i.UNITS_MSEC?"Milliseconds":t===i.UNITS_USEC?"Microseconds":t===i.UNITS_HZ?"Hz":t===i.UNITS_PPM?"PPM":t===i.UNITS_RADS?"Rads":"Unknown"};getQformMat(){return this.convertNiftiQFormToNiftiSForm(this.quatern_b,this.quatern_c,this.quatern_d,this.qoffset_x,this.qoffset_y,this.qoffset_z,this.pixDims[1],this.pixDims[2],this.pixDims[3],this.pixDims[0])}convertNiftiQFormToNiftiSForm(t,e,r,n,o,s,h,f,u,g){var a=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],c,v=t,p=e,m=r,E,C,I;return a[3][0]=a[3][1]=a[3][2]=0,a[3][3]=1,c=1-(v*v+p*p+m*m),c<1e-7?(c=1/Math.sqrt(v*v+p*p+m*m),v*=c,p*=c,m*=c,c=0):c=Math.sqrt(c),E=h>0?h:1,C=f>0?f:1,I=u>0?u:1,g<0&&(I=-I),a[0][0]=(c*c+v*v-p*p-m*m)*E,a[0][1]=2*(v*p-c*m)*C,a[0][2]=2*(v*m+c*p)*I,a[1][0]=2*(v*p+c*m)*E,a[1][1]=(c*c+p*p-v*v-m*m)*C,a[1][2]=2*(p*m-c*v)*I,a[2][0]=2*(v*m-c*p)*E,a[2][1]=2*(p*m+c*v)*C,a[2][2]=(c*c+m*m-p*p-v*v)*I,a[0][3]=n,a[1][3]=o,a[2][3]=s,a}convertNiftiSFormToNEMA(t){var e,r,n,o,s,h,f,u,g,a,c,v,p,m,E,C,I,w,R,L,G,Z,k,B,P,S,T,y,q,z,M,F,D,_;if(E=0,T=[[0,0,0],[0,0,0],[0,0,0]],y=[[0,0,0],[0,0,0],[0,0,0]],e=t[0][0],r=t[0][1],n=t[0][2],o=t[1][0],s=t[1][1],h=t[1][2],f=t[2][0],u=t[2][1],g=t[2][2],a=Math.sqrt(e*e+o*o+f*f),a===0||(e/=a,o/=a,f/=a,a=Math.sqrt(r*r+s*s+u*u),a===0))return null;if(r/=a,s/=a,u/=a,a=e*r+o*s+f*u,Math.abs(a)>1e-4){if(r-=a*e,s-=a*o,u-=a*f,a=Math.sqrt(r*r+s*s+u*u),a===0)return null;r/=a,s/=a,u/=a}if(a=Math.sqrt(n*n+h*h+g*g),a===0?(n=o*u-f*s,h=f*r-u*e,g=e*s-o*r):(n/=a,h/=a,g/=a),a=e*n+o*h+f*g,Math.abs(a)>1e-4){if(n-=a*e,h-=a*o,g-=a*f,a=Math.sqrt(n*n+h*h+g*g),a===0)return null;n/=a,h/=a,g/=a}if(a=r*n+s*h+u*g,Math.abs(a)>1e-4){if(n-=a*r,h-=a*s,g-=a*u,a=Math.sqrt(n*n+h*h+g*g),a===0)return null;n/=a,h/=a,g/=a}if(T[0][0]=e,T[0][1]=r,T[0][2]=n,T[1][0]=o,T[1][1]=s,T[1][2]=h,T[2][0]=f,T[2][1]=u,T[2][2]=g,c=this.nifti_mat33_determ(T),c===0)return null;for(S=-666,R=Z=k=B=1,L=2,G=3,p=1;p<=3;p+=1)for(m=1;m<=3;m+=1)if(p!==m){for(E=1;E<=3;E+=1)if(!(p===E||m===E))for(y[0][0]=y[0][1]=y[0][2]=y[1][0]=y[1][1]=y[1][2]=y[2][0]=y[2][1]=y[2][2]=0,C=-1;C<=1;C+=2)for(I=-1;I<=1;I+=2)for(w=-1;w<=1;w+=2)y[0][p-1]=C,y[1][m-1]=I,y[2][E-1]=w,v=this.nifti_mat33_determ(y),v*c>0&&(P=this.nifti_mat33_mul(y,T),a=P[0][0]+P[1][1]+P[2][2],a>S&&(S=a,R=p,L=m,G=E,Z=C,k=I,B=w))}switch(q=z=M=F=D=_="",R*Z){case 1:q="X",F="+";break;case-1:q="X",F="-";break;case 2:q="Y",F="+";break;case-2:q="Y",F="-";break;case 3:q="Z",F="+";break;case-3:q="Z",F="-";break}switch(L*k){case 1:z="X",D="+";break;case-1:z="X",D="-";break;case 2:z="Y",D="+";break;case-2:z="Y",D="-";break;case 3:z="Z",D="+";break;case-3:z="Z",D="-";break}switch(G*B){case 1:M="X",_="+";break;case-1:M="X",_="-";break;case 2:M="Y",_="+";break;case-2:M="Y",_="-";break;case 3:M="Z",_="+";break;case-3:M="Z",_="-";break}return q+z+M+F+D+_}nifti_mat33_mul=function(t,e){var r=[[0,0,0],[0,0,0],[0,0,0]],n,o;for(n=0;n<3;n+=1)for(o=0;o<3;o+=1)r[n][o]=t[n][0]*e[0][o]+t[n][1]*e[1][o]+t[n][2]*e[2][o];return r};nifti_mat33_determ=function(t){var e,r,n,o,s,h,f,u,g;return e=t[0][0],r=t[0][1],n=t[0][2],o=t[1][0],s=t[1][1],h=t[1][2],f=t[2][0],u=t[2][1],g=t[2][2],e*s*g-e*u*h-o*r*g+o*u*n+f*r*h-f*s*n};getExtensionLocation(){return i.MAGIC_COOKIE+4}getExtensionSize(t){return l.getIntAt(t,this.getExtensionLocation(),this.littleEndian)}getExtensionCode(t){return l.getIntAt(t,this.getExtensionLocation()+4,this.littleEndian)}addExtension(t,e=-1){e==-1?this.extensions.push(t):this.extensions.splice(e,0,t),this.vox_offset+=t.esize}removeExtension(t){let e=this.extensions[t];e&&(this.vox_offset-=e.esize),this.extensions.splice(t,1)}toArrayBuffer(t=!1){let n=352;if(t)for(let f of this.extensions)n+=f.esize;let o=new Uint8Array(n),s=new DataView(o.buffer);s.setInt32(0,348,this.littleEndian),s.setUint8(39,this.dim_info);for(let f=0;f<8;f++)s.setUint16(40+2*f,this.dims[f],this.littleEndian);s.setFloat32(56,this.intent_p1,this.littleEndian),s.setFloat32(60,this.intent_p2,this.littleEndian),s.setFloat32(64,this.intent_p3,this.littleEndian),s.setInt16(68,this.intent_code,this.littleEndian),s.setInt16(70,this.datatypeCode,this.littleEndian),s.setInt16(72,this.numBitsPerVoxel,this.littleEndian),s.setInt16(74,this.slice_start,this.littleEndian);for(let f=0;f<8;f++)s.setFloat32(76+4*f,this.pixDims[f],this.littleEndian);s.setFloat32(108,this.vox_offset,this.littleEndian),s.setFloat32(112,this.scl_slope,this.littleEndian),s.setFloat32(116,this.scl_inter,this.littleEndian),s.setInt16(120,this.slice_end,this.littleEndian),s.setUint8(122,this.slice_code),s.setUint8(123,this.xyzt_units),s.setFloat32(124,this.cal_max,this.littleEndian),s.setFloat32(128,this.cal_min,this.littleEndian),s.setFloat32(132,this.slice_duration,this.littleEndian),s.setFloat32(136,this.toffset,this.littleEndian),o.set(new TextEncoder().encode(this.description),148),o.set(new TextEncoder().encode(this.aux_file),228),s.setInt16(252,this.qform_code,this.littleEndian),s.setInt16(254,this.sform_code,this.littleEndian),s.setFloat32(256,this.quatern_b,this.littleEndian),s.setFloat32(260,this.quatern_c,this.littleEndian),s.setFloat32(264,this.quatern_d,this.littleEndian),s.setFloat32(268,this.qoffset_x,this.littleEndian),s.setFloat32(272,this.qoffset_y,this.littleEndian),s.setFloat32(276,this.qoffset_z,this.littleEndian);let h=this.affine.flat();for(let f=0;f<12;f++)s.setFloat32(280+4*f,h[f],this.littleEndian);if(o.set(new TextEncoder().encode(this.intent_name),328),o.set(new TextEncoder().encode(this.magic),344),t){o.set(Uint8Array.from([1,0,0,0]),348);let f=this.getExtensionLocation();for(let u of this.extensions)s.setInt32(f,u.esize,u.littleEndian),s.setInt32(f+4,u.ecode,u.littleEndian),o.set(new Uint8Array(u.edata),f+8),f+=u.esize}else o.set(new Uint8Array(4).fill(0),348);return o.buffer}};var A=class i{littleEndian=!1;dim_info=0;dims=[];intent_p1=0;intent_p2=0;intent_p3=0;intent_code=0;datatypeCode=0;numBitsPerVoxel=0;slice_start=0;slice_end=0;slice_code=0;pixDims=[];vox_offset=0;scl_slope=1;scl_inter=0;xyzt_units=0;cal_max=0;cal_min=0;slice_duration=0;toffset=0;description="";aux_file="";intent_name="";qform_code=0;sform_code=0;quatern_b=0;quatern_c=0;quatern_d=0;qoffset_x=0;qoffset_y=0;qoffset_z=0;affine=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];magic="0";extensionFlag=[0,0,0,0];extensions=[];extensionSize=0;extensionCode=0;static MAGIC_COOKIE=540;static MAGIC_NUMBER_LOCATION=4;static MAGIC_NUMBER=[110,43,50,0,13,10,26,10];static MAGIC_NUMBER2=[110,105,50,0,13,10,26,10];readHeader(t){var e=new DataView(t),r=l.getIntAt(e,0,this.littleEndian),n,o,s,h,f;if(r!==i.MAGIC_COOKIE&&(this.littleEndian=!0,r=l.getIntAt(e,0,this.littleEndian)),r!==i.MAGIC_COOKIE)throw new Error("This does not appear to be a NIFTI file!");for(this.magic=l.getStringAt(e,4,12),this.datatypeCode=l.getShortAt(e,12,this.littleEndian),this.numBitsPerVoxel=l.getShortAt(e,14,this.littleEndian),n=0;n<8;n+=1)h=16+n*8,this.dims[n]=l.getInt64At(e,h,this.littleEndian);for(this.intent_p1=l.getDoubleAt(e,80,this.littleEndian),this.intent_p2=l.getDoubleAt(e,88,this.littleEndian),this.intent_p3=l.getDoubleAt(e,96,this.littleEndian),n=0;n<8;n+=1)h=104+n*8,this.pixDims[n]=l.getDoubleAt(e,h,this.littleEndian);for(this.vox_offset=l.getInt64At(e,168,this.littleEndian),this.scl_slope=l.getDoubleAt(e,176,this.littleEndian),this.scl_inter=l.getDoubleAt(e,184,this.littleEndian),this.cal_max=l.getDoubleAt(e,192,this.littleEndian),this.cal_min=l.getDoubleAt(e,200,this.littleEndian),this.slice_duration=l.getDoubleAt(e,208,this.littleEndian),this.toffset=l.getDoubleAt(e,216,this.littleEndian),this.slice_start=l.getInt64At(e,224,this.littleEndian),this.slice_end=l.getInt64At(e,232,this.littleEndian),this.description=l.getStringAt(e,240,320),this.aux_file=l.getStringAt(e,320,344),this.qform_code=l.getIntAt(e,344,this.littleEndian),this.sform_code=l.getIntAt(e,348,this.littleEndian),this.quatern_b=l.getDoubleAt(e,352,this.littleEndian),this.quatern_c=l.getDoubleAt(e,360,this.littleEndian),this.quatern_d=l.getDoubleAt(e,368,this.littleEndian),this.qoffset_x=l.getDoubleAt(e,376,this.littleEndian),this.qoffset_y=l.getDoubleAt(e,384,this.littleEndian),this.qoffset_z=l.getDoubleAt(e,392,this.littleEndian),o=0;o<3;o+=1)for(s=0;s<4;s+=1)h=400+(o*4+s)*8,this.affine[o][s]=l.getDoubleAt(e,h,this.littleEndian);this.affine[3][0]=0,this.affine[3][1]=0,this.affine[3][2]=0,this.affine[3][3]=1,this.slice_code=l.getIntAt(e,496,this.littleEndian),this.xyzt_units=l.getIntAt(e,500,this.littleEndian),this.intent_code=l.getIntAt(e,504,this.littleEndian),this.intent_name=l.getStringAt(e,508,524),this.dim_info=l.getByteAt(e,524),e.byteLength>i.MAGIC_COOKIE&&(this.extensionFlag[0]=l.getByteAt(e,540),this.extensionFlag[1]=l.getByteAt(e,541),this.extensionFlag[2]=l.getByteAt(e,542),this.extensionFlag[3]=l.getByteAt(e,543),this.extensionFlag[0]&&(this.extensions=l.getExtensionsAt(e,this.getExtensionLocation(),this.littleEndian,this.vox_offset),this.extensionSize=this.extensions[0].esize,this.extensionCode=this.extensions[0].ecode))}toFormattedString(){var t=l.formatNumber,e="";return e+="Datatype = "+ +this.datatypeCode+" ("+this.getDatatypeCodeString(this.datatypeCode)+`)
`,e+="Bits Per Voxel =  = "+this.numBitsPerVoxel+`
`,e+="Image Dimensions (1-8): "+this.dims[0]+", "+this.dims[1]+", "+this.dims[2]+", "+this.dims[3]+", "+this.dims[4]+", "+this.dims[5]+", "+this.dims[6]+", "+this.dims[7]+`
`,e+="Intent Parameters (1-3): "+this.intent_p1+", "+this.intent_p2+", "+this.intent_p3+`
`,e+="Voxel Dimensions (1-8): "+t(this.pixDims[0])+", "+t(this.pixDims[1])+", "+t(this.pixDims[2])+", "+t(this.pixDims[3])+", "+t(this.pixDims[4])+", "+t(this.pixDims[5])+", "+t(this.pixDims[6])+", "+t(this.pixDims[7])+`
`,e+="Image Offset = "+this.vox_offset+`
`,e+="Data Scale:  Slope = "+t(this.scl_slope)+"  Intercept = "+t(this.scl_inter)+`
`,e+="Display Range:  Max = "+t(this.cal_max)+"  Min = "+t(this.cal_min)+`
`,e+="Slice Duration = "+this.slice_duration+`
`,e+="Time Axis Shift = "+this.toffset+`
`,e+="Slice Start = "+this.slice_start+`
`,e+="Slice End = "+this.slice_end+`
`,e+='Description: "'+this.description+`"
`,e+='Auxiliary File: "'+this.aux_file+`"
`,e+="Q-Form Code = "+this.qform_code+" ("+this.getTransformCodeString(this.qform_code)+`)
`,e+="S-Form Code = "+this.sform_code+" ("+this.getTransformCodeString(this.sform_code)+`)
`,e+="Quaternion Parameters:  b = "+t(this.quatern_b)+"  c = "+t(this.quatern_c)+"  d = "+t(this.quatern_d)+`
`,e+="Quaternion Offsets:  x = "+this.qoffset_x+"  y = "+this.qoffset_y+"  z = "+this.qoffset_z+`
`,e+="S-Form Parameters X: "+t(this.affine[0][0])+", "+t(this.affine[0][1])+", "+t(this.affine[0][2])+", "+t(this.affine[0][3])+`
`,e+="S-Form Parameters Y: "+t(this.affine[1][0])+", "+t(this.affine[1][1])+", "+t(this.affine[1][2])+", "+t(this.affine[1][3])+`
`,e+="S-Form Parameters Z: "+t(this.affine[2][0])+", "+t(this.affine[2][1])+", "+t(this.affine[2][2])+", "+t(this.affine[2][3])+`
`,e+="Slice Code = "+this.slice_code+`
`,e+="Units Code = "+this.xyzt_units+" ("+this.getUnitsCodeString(d.SPATIAL_UNITS_MASK&this.xyzt_units)+", "+this.getUnitsCodeString(d.TEMPORAL_UNITS_MASK&this.xyzt_units)+`)
`,e+="Intent Code = "+this.intent_code+`
`,e+='Intent Name: "'+this.intent_name+`"
`,e+="Dim Info = "+this.dim_info+`
`,e}getExtensionLocation=function(){return i.MAGIC_COOKIE+4};getExtensionSize=d.prototype.getExtensionSize;getExtensionCode=d.prototype.getExtensionCode;addExtension=d.prototype.addExtension;removeExtension=d.prototype.removeExtension;getDatatypeCodeString=d.prototype.getDatatypeCodeString;getTransformCodeString=d.prototype.getTransformCodeString;getUnitsCodeString=d.prototype.getUnitsCodeString;getQformMat=d.prototype.getQformMat;convertNiftiQFormToNiftiSForm=d.prototype.convertNiftiQFormToNiftiSForm;convertNiftiSFormToNEMA=d.prototype.convertNiftiSFormToNEMA;nifti_mat33_mul=d.prototype.nifti_mat33_mul;nifti_mat33_determ=d.prototype.nifti_mat33_determ;toArrayBuffer(t=!1){let n=544;if(t)for(let f of this.extensions)n+=f.esize;let o=new Uint8Array(n),s=new DataView(o.buffer);s.setInt32(0,540,this.littleEndian),o.set(new TextEncoder().encode(this.magic),4),s.setInt16(12,this.datatypeCode,this.littleEndian),s.setInt16(14,this.numBitsPerVoxel,this.littleEndian);for(let f=0;f<8;f++)s.setBigInt64(16+8*f,BigInt(this.dims[f]),this.littleEndian);s.setFloat64(80,this.intent_p1,this.littleEndian),s.setFloat64(88,this.intent_p2,this.littleEndian),s.setFloat64(96,this.intent_p3,this.littleEndian);for(let f=0;f<8;f++)s.setFloat64(104+8*f,this.pixDims[f],this.littleEndian);s.setBigInt64(168,BigInt(this.vox_offset),this.littleEndian),s.setFloat64(176,this.scl_slope,this.littleEndian),s.setFloat64(184,this.scl_inter,this.littleEndian),s.setFloat64(192,this.cal_max,this.littleEndian),s.setFloat64(200,this.cal_min,this.littleEndian),s.setFloat64(208,this.slice_duration,this.littleEndian),s.setFloat64(216,this.toffset,this.littleEndian),s.setBigInt64(224,BigInt(this.slice_start),this.littleEndian),s.setBigInt64(232,BigInt(this.slice_end),this.littleEndian),o.set(new TextEncoder().encode(this.description),240),o.set(new TextEncoder().encode(this.aux_file),320),s.setInt32(344,this.qform_code,this.littleEndian),s.setInt32(348,this.sform_code,this.littleEndian),s.setFloat64(352,this.quatern_b,this.littleEndian),s.setFloat64(360,this.quatern_c,this.littleEndian),s.setFloat64(368,this.quatern_d,this.littleEndian),s.setFloat64(376,this.qoffset_x,this.littleEndian),s.setFloat64(384,this.qoffset_y,this.littleEndian),s.setFloat64(392,this.qoffset_z,this.littleEndian);let h=this.affine.flat();for(let f=0;f<12;f++)s.setFloat64(400+8*f,h[f],this.littleEndian);if(s.setInt32(496,this.slice_code,this.littleEndian),s.setInt32(500,this.xyzt_units,this.littleEndian),s.setInt32(504,this.intent_code,this.littleEndian),o.set(new TextEncoder().encode(this.intent_name),508),s.setUint8(524,this.dim_info),t){o.set(Uint8Array.from([1,0,0,0]),540);let f=this.getExtensionLocation();for(let u of this.extensions)s.setInt32(f,u.esize,u.littleEndian),s.setInt32(f+4,u.ecode,u.littleEndian),o.set(new Uint8Array(u.edata),f+8),f+=u.esize}else o.set(new Uint8Array(4).fill(0),540);return o.buffer}};function st(i,t=!1){var e,r,n,o;return i.byteLength<d.STANDARD_HEADER_SIZE?!1:(e=new DataView(i),e&&(r=e.getUint8(d.MAGIC_NUMBER_LOCATION)),n=e.getUint8(d.MAGIC_NUMBER_LOCATION+1),o=e.getUint8(d.MAGIC_NUMBER_LOCATION+2),t&&r===d.MAGIC_NUMBER2[0]&&n===d.MAGIC_NUMBER2[1]&&o===d.MAGIC_NUMBER2[2]?!0:r===d.MAGIC_NUMBER[0]&&n===d.MAGIC_NUMBER[1]&&o===d.MAGIC_NUMBER[2])}function at(i,t=!1){var e,r,n,o;return i.byteLength<d.STANDARD_HEADER_SIZE?!1:(e=new DataView(i),r=e.getUint8(A.MAGIC_NUMBER_LOCATION),n=e.getUint8(A.MAGIC_NUMBER_LOCATION+1),o=e.getUint8(A.MAGIC_NUMBER_LOCATION+2),t&&r===A.MAGIC_NUMBER2[0]&&n===A.MAGIC_NUMBER2[1]&&o===A.MAGIC_NUMBER2[2]?!0:r===A.MAGIC_NUMBER[0]&&n===A.MAGIC_NUMBER[1]&&o===A.MAGIC_NUMBER[2])}function Wt(i,t=!1){return st(i,t)||at(i,t)}function ot(i){var t,e,r;return!!(i&&(t=new DataView(i),e=t.getUint8(0),r=t.getUint8(1),e===l.GUNZIP_MAGIC_COOKIE1||r===l.GUNZIP_MAGIC_COOKIE2))}function At(i){return _t(new Uint8Array(i)).buffer}async function $t(i){let t=new Uint8Array(i),e=t[0]===31&&t[1]===139&&t[2]===8?"gzip":t[0]===120&&(t[1]===1||t[1]===94||t[1]===156||t[1]===218)?"deflate":"deflate-raw",r=new DecompressionStream(e),n=r.writable.getWriter();n.write(t).catch(console.error);let o=n.close().catch(console.error),h=await new Response(r.readable).arrayBuffer();return await o,h}async function rt(i,t=1/0){let e=v=>v[0]===31&&v[1]===139&&v[2]===8?"gzip":v[0]===120&&[1,94,156,218].includes(v[1])?"deflate":"deflate-raw",r=new Uint8Array(i),n=e(r),o=new DecompressionStream(n),s=new TransformStream({transform(v,p){p.enqueue(v)},flush(v){v.terminate()}}),{readable:h,writable:f}=o,u=f.getWriter(),g=h.pipeThrough(s).getReader();u.write(r).catch(v=>{v instanceof Error&&v.name==="AbortError"||console.error("Error during write:",v)});let a=[],c=0;try{for(;c<t;){let{done:v,value:p}=await g.read();if(v)break;let m=t-c,E=p.subarray(0,Math.min(p.length,m));if(a.push(E),c+=E.length,c>=t){await Promise.all([g.cancel().catch(()=>{}),u.abort().catch(()=>{})]);break}}}catch(v){v instanceof Error&&v.name==="AbortError"||console.error("Error during decompression:",v)}finally{await Promise.allSettled([g.cancel().catch(()=>{}),u.close().catch(()=>{})])}return a.length===1?a[0].buffer:a.reduce((v,p)=>{let m=new Uint8Array(v.byteLength+p.byteLength);return m.set(new Uint8Array(v),0),m.set(p,v.byteLength),m.buffer},new ArrayBuffer(0))}function It(i,t=!1){let e=null;if(ot(i)&&(i=At(i)),st(i,t)?e=new d:at(i,t)&&(e=new A),e)e.readHeader(i);else throw new Error("That file does not appear to be NIFTI!");return e}async function Jt(i,t=!1){if(!ot(i))return It(i,t);let e=null,r=await rt(i,540),n=!0,o=!0;var s=new DataView(r);let h=s.getInt32(0,!0),f=s.getInt32(0,!1);if(h!==348)if(f===348)n=!1;else if(h===540)o=!1;else if(f===540)o=!1,n=!1;else throw new Error("That file does not appear to be NIFTI!");let u=Math.round(s.getFloat32(108,n));return A&&(u=l.getUint64At(s,168,n)),u>r.byteLength&&(r=await rt(i,u)),o?e=new d:e=new A,e.readHeader(r),e}function te(i){return i.extensionFlag[0]!=0}function ee(i,t){var e=i.vox_offset,r=1,n=1;i.dims[4]&&(r=i.dims[4]),i.dims[5]&&(n=i.dims[5]);var o=i.dims[1]*i.dims[2]*i.dims[3]*r*n*(i.numBitsPerVoxel/8);return t.slice(e,e+o)}function ie(i,t){var e=i.getExtensionLocation(),r=i.extensionSize;return t.slice(e,e+r)}function ne(i,t){var e=i.getExtensionLocation(),r=i.extensionSize;return t.slice(e+8,e+r)}return zt(re);})();
